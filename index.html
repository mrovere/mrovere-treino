<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Plano de Treino – 4 Semanas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--azul:#4a90e2;--cinza:#f7f7f7;--borda:#d0d0d0;}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--cinza);color:#222}
    header{padding:18px 16px;background:#fff;border-bottom:1px solid var(--borda)}
    h1{margin:0;text-align:center}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--borda);border-radius:10px;padding:16px;margin-bottom:18px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #bbb;padding:8px;vertical-align:top}
    th{background:var(--azul);color:#fff}
    .btn{background:var(--azul);color:#fff;border:none;border-radius:6px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-outline{background:#fff;color:var(--azul);border:1px solid var(--azul)}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    label{font-weight:600;margin-top:8px;display:block}
    input,select,textarea{width:100%;padding:9px;border:1px solid #ccc;border-radius:6px;margin-top:6px}
    textarea{min-height:90px}
    .muted{color:#666;font-size:.9rem}
    .row{display:flex;gap:8px;align-items:center}
    .chip{display:inline-block;padding:4px 8px;border-radius:20px;background:#eef3ff;color:#2c5bbf;margin-right:6px;font-size:.85rem}
    .right{float:right}
    .table-sm td,.table-sm th{font-size:.92rem}
    .activity{border-bottom:1px dashed #ddd;padding:8px 0}
    .nowrap{white-space:nowrap}
    .danger{color:#b00020}
    .ok{color:#0c7a35}
    .center{text-align:center}
    @media(max-width:800px){.grid-2,.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>📊 Plano de Treino – 4 Semanas</h1>
  </header>

  <main>
    <!-- PLANO -->
    <section class="card">
      <h2 style="margin-top:0">Plano (referência)</h2>
      <div class="muted">Use como guia. Você pode registrar atividades reais abaixo.</div>
      <div style="overflow:auto">
        <table class="table-sm">
          <tr>
            <th>Semana</th>
            <th>Dia A – Ombro + Peito</th>
            <th>Dia B – Costas + Bíceps</th>
            <th>Dia C – Pernas + Tríceps + Core</th>
          </tr>
          <tr>
            <td>1 – Adaptação</td>
            <td>Rot. ext/int 3x12–15; Elevação lat 3x12–15; Desenvolv. 2x12–15; Supino 2x12–15; Flexão 2x falha</td>
            <td>Remada 3x12–15; Puxada 3x12–15; Face pull 3x12–15; Rosca direta 2x12–15; Rosca martelo 2x12–15</td>
            <td>Agacha 3x12–15; Afundo 2x12–15; Terra romeno 2x12–15; Tríceps testa 2x12–15; Mergulho 2x falha; Prancha 3x30s; Infra 3x12–15</td>
          </tr>
          <tr>
            <td>2 – Consolidação</td>
            <td>Rot. ext/int 3x12; Elevação lat 3x12; Desenvolv. 3x10–12; Supino 3x10–12; Flexão 3x falha</td>
            <td>Remada 3x10–12; Puxada 3x10–12; Face pull 3x12; Rosca direta 3x10–12; Rosca martelo 3x10–12</td>
            <td>Agacha 3x10–12; Afundo 3x10–12; Terra romeno 3x10–12; Tríceps testa 3x10–12; Mergulho 3x falha; Prancha 3x35s; Infra 3x12</td>
          </tr>
          <tr>
            <td>3 – Progressão</td>
            <td>Rot. ext/int 3x12; Elevação lat 4x10; Desenvolv. 4x8–10; Supino 4x8–10; Flexão 3x falha</td>
            <td>Remada 4x8–10; Puxada 4x8–10; Face pull 3x12; Rosca direta 3x10; Rosca martelo 3x10</td>
            <td>Agacha 4x8–10; Afundo 3x10; Terra romeno 3x8–10; Tríceps testa 3x10; Mergulho 3x falha; Prancha 3x40s; Infra 3x12</td>
          </tr>
          <tr>
            <td>4 – Choque</td>
            <td>Rot. ext/int 3x15; Elevação lat 4x12 (drop); Desenvolv. 4x10–12 (drop); Supino 4x10–12 (drop); Flexão 4x falha</td>
            <td>Remada 4x10–12 (drop); Puxada 4x10–12 (drop); Face pull 4x12; Rosca direta 4x12 (drop); Rosca martelo 4x12</td>
            <td>Agacha 4x10–12 (drop); Afundo 3x12; Terra romeno 4x10; Tríceps testa 4x12 (drop); Mergulho 4x falha; Prancha 3x45s; Infra 3x15</td>
          </tr>
        </table>
      </div>
      <div style="margin-top:12px">
        <button class="btn" id="btnAdd">➕ Adicionar atividade</button>
        <button class="btn btn-outline right" id="btnExport">Backup (Exportar JSON)</button>
        <label class="right" style="margin-right:8px;">
          <input type="file" id="importFile" accept="application/json" style="display:none">
          <span class="btn btn-outline" id="btnImport">Restaurar (Importar JSON)</span>
        </label>
        <div style="clear:both"></div>
        <div class="muted">Os dados ficam salvos neste navegador (localStorage). Faça backup para não perder ao trocar de aparelho.</div>
      </div>
    </section>

    <!-- FORMULÁRIO -->
    <section class="card" id="formCard" style="display:none">
      <h2 style="margin-top:0">Nova atividade</h2>
      <div class="grid grid-3">
        <div>
          <label for="fase">Fase (semana)</label>
          <select id="fase">
            <option value="Semana 1">Semana 1</option>
            <option value="Semana 2">Semana 2</option>
            <option value="Semana 3">Semana 3</option>
            <option value="Semana 4">Semana 4</option>
          </select>
        </div>
        <div>
          <label for="grupo">Grupo muscular</label>
          <select id="grupo">
            <option value="Ombro + Peito">Ombro + Peito</option>
            <option value="Costas + Bíceps">Costas + Bíceps</option>
            <option value="Pernas + Tríceps + Core">Pernas + Tríceps + Core</option>
          </select>
        </div>
        <div>
          <label for="data">Data</label>
          <input type="date" id="data"/>
        </div>
      </div>

      <h3>Séries do dia</h3>
      <div id="setsWrap"></div>
      <button class="btn btn-outline" id="btnAddSet" type="button">+ Adicionar exercício</button>

      <label for="obs">Observações</label>
      <textarea id="obs" placeholder="Como se sentiu? Dor? Técnica? Sono/energia?"></textarea>

      <div style="margin-top:12px" class="row">
        <button class="btn" id="btnSave">Concluir e salvar</button>
        <button class="btn btn-outline" id="btnCancel" type="button">Cancelar</button>
      </div>
    </section>

    <!-- ATIVIDADES -->
    <section class="card">
      <h2 style="margin-top:0">Histórico</h2>
      <div id="listaAtividades"></div>
    </section>

    <!-- DASHBOARD -->
    <section class="card">
      <h2 style="margin-top:0">📈 Dashboard</h2>
      <div class="grid grid-2">
        <div>
          <h3 class="center" style="margin:4px 0">Treinos por semana</h3>
          <canvas id="chartSemanas" height="220"></canvas>
        </div>
        <div>
          <h3 class="center" style="margin:4px 0">Volume por grupo (kg·reps)</h3>
          <canvas id="chartGrupos" height="220"></canvas>
        </div>
      </div>
      <div class="grid grid-2" style="margin-top:16px">
        <div>
          <h3 class="center" style="margin:4px 0">Tendência de um exercício</h3>
          <div class="row" style="gap:10px;margin-bottom:6px">
            <input id="filterEx" placeholder="Ex.: Supino reto"/>
            <button class="btn btn-outline" id="btnFiltrar">Plotar</button>
          </div>
          <canvas id="chartExercicio" height="220"></canvas>
          <div class="muted">Dica: use o nome do exercício exatamente como registrou.</div>
        </div>
        <div>
          <h3 class="center" style="margin:4px 0">Estatísticas rápidas</h3>
          <div id="stats"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ---------- Persistência ----------
    const KEY = "atividadesTreinoV1";

    const getData = () => JSON.parse(localStorage.getItem(KEY) || "[]");
    const setData = (arr) => localStorage.setItem(KEY, JSON.stringify(arr));

    // ---------- Utilitários ----------
    const fmtDate = (iso) => {
      if(!iso) return "";
      const d = new Date(iso + "T00:00:00");
      return d.toLocaleDateString("pt-BR");
    };
    const weekKey = (iso) => {
      const d = new Date(iso + "T00:00:00");
      const year = d.getFullYear();
      // aproximação simples de semana (YYYY-WW)
      const onejan = new Date(d.getFullYear(),0,1);
      const week = Math.ceil((((d - onejan)/86400000) + onejan.getDay()+1)/7);
      return `${year}-S${String(week).padStart(2,"0")}`;
    };
    const sum = (arr) => arr.reduce((a,b)=>a+b,0);

    // ---------- UI: formulário dinâmico ----------
    const setsWrap = document.getElementById("setsWrap");
    function addSetRow(prefill={exercicio:"", series:[{reps:"",carga:""}]}) {
      const idx = document.querySelectorAll(".set-block").length;
      const block = document.createElement("div");
      block.className = "set-block card";
      block.style.padding = "12px";
      block.style.marginBottom = "10px";
      block.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div style="flex:1">
            <label>Exercício</label>
            <input class="exNome" placeholder="Ex.: Supino reto" value="${prefill.exercicio||""}">
          </div>
          <button class="btn btn-outline" type="button" onclick="this.closest('.set-block').remove()">Remover</button>
        </div>
        <div class="seriesWrap"></div>
        <button class="btn btn-outline" type="button">+ Série</button>
      `;
      const btnAddSerie = block.querySelector("button.btn.btn-outline:last-of-type");
      const seriesWrap = block.querySelector(".seriesWrap");

      function addSerieRow(s={reps:"",carga:""}) {
        const r = document.createElement("div");
        r.className="row";
        r.style.marginTop="8px";
        r.innerHTML = `
          <label style="min-width:70px">Reps</label>
          <input class="reps" type="number" min="0" style="max-width:120px">
          <label style="min-width:70px">Carga (kg)</label>
          <input class="carga" type="number" min="0" step="0.5" style="max-width:140px">
          <button class="btn btn-outline" type="button">–</button>
        `;
        r.querySelector(".reps").value = s.reps || "";
        r.querySelector(".carga").value = s.carga || "";
        r.querySelector("button").onclick = ()=> r.remove();
        seriesWrap.appendChild(r);
      }
      // preencher séries existentes
      (prefill.series || [{reps:"",carga:""}]).forEach(addSerieRow);
      btnAddSerie.onclick = ()=> addSerieRow();

      setsWrap.appendChild(block);
    }

    // ---------- Mostrar/ocultar formulário ----------
    const formCard = document.getElementById("formCard");
    document.getElementById("btnAdd").onclick = ()=>{
      formCard.style.display = "block";
      if(!setsWrap.querySelector(".set-block")) addSetRow();
      document.getElementById("data").valueAsDate = new Date();
    };
    document.getElementById("btnCancel").onclick = ()=>{
      formCard.style.display = "none";
      setsWrap.innerHTML = "";
      document.getElementById("obs").value = "";
    };
    document.getElementById("btnAddSet").onclick = ()=> addSetRow();

    // ---------- Salvar atividade ----------
    document.getElementById("btnSave").onclick = ()=>{
      const fase = document.getElementById("fase").value;
      const grupo = document.getElementById("grupo").value;
      const data = document.getElementById("data").value;
      const obs = document.getElementById("obs").value;

      if(!data){ alert("Informe a data."); return; }

      const sets = Array.from(document.querySelectorAll(".set-block")).map(b=>{
        const exercicio = b.querySelector(".exNome").value.trim();
        const series = Array.from(b.querySelectorAll(".seriesWrap .row")).map(r=>{
          const reps = Number(r.querySelector(".reps").value) || 0;
          const carga = Number(r.querySelector(".carga").value) || 0;
          return {reps,carga};
        }).filter(s=> s.reps>0 || s.carga>0);
        return {exercicio, series};
      }).filter(s=> s.exercicio && s.series.length);

      if(!sets.length){ alert("Adicione ao menos um exercício com séries."); return; }

      const atividades = getData();
      atividades.push({id:crypto.randomUUID(), data, fase, grupo, sets, obs});
      setData(atividades);

      // limpar e fechar
      document.getElementById("btnCancel").click();
      renderHistorico();
      renderDash();
    };

    // ---------- Histórico ----------
    function calcVolume(atividade){
      // volume = soma (reps * carga) de todas as séries
      let total = 0;
      atividade.sets.forEach(s=>{
        s.series.forEach(x=> total += (x.reps||0) * (x.carga||0));
      });
      return total;
    }

    function renderHistorico(){
      const cont = document.getElementById("listaAtividades");
      const atividades = getData().sort((a,b)=> a.data < b.data ? 1 : -1);
      if(!atividades.length){ cont.innerHTML = '<div class="muted">Sem atividades registradas ainda.</div>'; return; }

      cont.innerHTML = "";
      atividades.forEach(a=>{
        const vol = calcVolume(a);
        const div = document.createElement("div");
        div.className = "activity";
        div.innerHTML = `
          <div><b>${fmtDate(a.data)}</b> · <span class="chip">${a.fase}</span> <span class="chip">${a.grupo}</span>
            <span class="right">
              <button class="btn btn-outline btn-sm" data-id="${a.id}">Editar</button>
              <button class="btn btn-outline btn-sm danger" data-del="${a.id}">Excluir</button>
            </span>
          </div>
          <div class="muted">Volume: <b>${vol.toFixed(1)}</b> kg·reps</div>
          <div style="margin-top:6px">${a.sets.map(s=>{
            const seriesTxt = s.series.map((x,i)=>`S${i+1}:${x.reps}x${x.carga}kg`).join(" · ");
            return `<div>• <b>${s.exercicio}</b> — ${seriesTxt}</div>`;
          }).join("")}</div>
          ${a.obs ? `<div class="muted" style="margin-top:6px">Obs: ${a.obs}</div>` : ""}
        `;
        // excluir
        div.querySelector("[data-del]").onclick = (e)=>{
          const id = e.target.getAttribute("data-del");
          const arr = getData().filter(x=>x.id!==id);
          setData(arr);
          renderHistorico(); renderDash();
        };
        // editar (carrega no form)
        div.querySelector("[data-id]").onclick = (e)=>{
          const id = e.target.getAttribute("data-id");
          const at = getData().find(x=>x.id===id);
          if(!at) return;
          formCard.style.display = "block";
          document.getElementById("fase").value = at.fase;
          document.getElementById("grupo").value = at.grupo;
          document.getElementById("data").value = at.data;
          document.getElementById("obs").value = at.obs || "";
          setsWrap.innerHTML="";
          at.sets.forEach(s=> addSetRow({exercicio:s.exercicio, series:s.series}));
          // ao salvar, substitui
          document.getElementById("btnSave").onclick = ()=>{
            const fase = document.getElementById("fase").value;
            const grupo = document.getElementById("grupo").value;
            const data = document.getElementById("data").value;
            const obs = document.getElementById("obs").value;
            if(!data){ alert("Informe a data."); return; }
            const sets = Array.from(document.querySelectorAll(".set-block")).map(b=>{
              const exercicio = b.querySelector(".exNome").value.trim();
              const series = Array.from(b.querySelectorAll(".seriesWrap .row")).map(r=>{
                const reps = Number(r.querySelector(".reps").value) || 0;
                const carga = Number(r.querySelector(".carga").value) || 0;
                return {reps,carga};
              }).filter(s=> s.reps>0 || s.carga>0);
              return {exercicio, series};
            }).filter(s=> s.exercicio && s.series.length);

            if(!sets.length){ alert("Adicione ao menos um exercício com séries."); return; }

            const arr = getData().map(x=> x.id===id ? ({...x, data, fase, grupo, sets, obs}) : x);
            setData(arr);
            document.getElementById("btnCancel").click();
            // volta o handler padrão
            resetSaveHandler();
            renderHistorico(); renderDash();
          };
        };
        cont.appendChild(div);
      });
    }

    function resetSaveHandler(){
      document.getElementById("btnSave").onclick = ()=>{
        const fase = document.getElementById("fase").value;
        const grupo = document.getElementById("grupo").value;
        const data = document.getElementById("data").value;
        const obs = document.getElementById("obs").value;
        if(!data){ alert("Informe a data."); return; }
        const sets = Array.from(document.querySelectorAll(".set-block")).map(b=>{
          const exercicio = b.querySelector(".exNome").value.trim();
          const series = Array.from(b.querySelectorAll(".seriesWrap .row")).map(r=>{
            const reps = Number(r.querySelector(".reps").value) || 0;
            const carga = Number(r.querySelector(".carga").value) || 0;
            return {reps,carga};
          }).filter(s=> s.reps>0 || s.carga>0);
          return {exercicio, series};
        }).filter(s=> s.exercicio && s.series.length);

        const atividades = getData();
        atividades.push({id:crypto.randomUUID(), data, fase, grupo, sets, obs});
        setData(atividades);
        document.getElementById("btnCancel").click();
        renderHistorico(); renderDash();
      };
    }

    // ---------- Dashboard (Chart.js) ----------
    let chSemanas, chGrupos, chEx;
    function renderDash(){
      const dados = getData();
      // 1) Treinos por semana
      const porSemana = {};
      dados.forEach(a=>{
        const key = weekKey(a.data);
        porSemana[key] = (porSemana[key]||0)+1;
      });
      const semLabels = Object.keys(porSemana).sort();
      const semVals   = semLabels.map(k=>porSemana[k]);

      // 2) Volume por grupo
      const porGrupo = {};
      dados.forEach(a=>{
        const vol = calcVolume(a);
        porGrupo[a.grupo] = (porGrupo[a.grupo]||0) + vol;
      });
      const gLabels = Object.keys(porGrupo);
      const gVals   = gLabels.map(k=> porGrupo[k]);

      // 3) Estatísticas rápidas
      const totalTreinos = dados.length;
      const totalVolume  = sum(dados.map(calcVolume));
      const ultimo = dados.slice().sort((a,b)=> a.data<b.data?1:-1)[0];
      const statsDiv = document.getElementById("stats");
      statsDiv.innerHTML = `
        <div><b>Total de treinos:</b> ${totalTreinos}</div>
        <div><b>Volume acumulado:</b> ${totalVolume.toFixed(1)} kg·reps</div>
        ${ultimo ? `<div><b>Último treino:</b> ${fmtDate(ultimo.data)} · <span class="chip">${ultimo.grupo}</span></div>` : ""}
      `;

      // charts
      const ctxS = document.getElementById("chartSemanas").getContext("2d");
      const ctxG = document.getElementById("chartGrupos").getContext("2d");
      if(chSemanas) chSemanas.destroy();
      if(chGrupos) chGrupos.destroy();

      chSemanas = new Chart(ctxS,{
        type:"bar",
        data:{labels:semLabels,datasets:[{label:"Treinos/semana",data:semVals}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
      });
      chGrupos = new Chart(ctxG,{
        type:"pie",
        data:{labels:gLabels,datasets:[{label:"Volume (kg·reps)",data:gVals}]},
        options:{responsive:true}
      });
    }

    // Tendência de exercício específico
    document.getElementById("btnFiltrar").onclick = ()=>{
      const nome = (document.getElementById("filterEx").value || "").trim().toLowerCase();
      const dados = getData().slice().sort((a,b)=> a.data>b.data?1:-1);
      const labels=[], vol=[], maxLoad=[];
      dados.forEach(a=>{
        // filtra sets com esse exercício
        let localVol = 0;
        let maxSerie = 0;
        a.sets.forEach(s=>{
          if(s.exercicio.toLowerCase()===nome){
            s.series.forEach(x=>{
              localVol += (x.reps||0)*(x.carga||0);
              if((x.carga||0)>maxSerie) maxSerie=x.carga||0;
            });
          }
        });
        if(localVol>0){
          labels.push(fmtDate(a.data));
          vol.push(localVol);
          maxLoad.push(maxSerie);
        }
      });
      const ctx = document.getElementById("chartExercicio").getContext("2d");
      if(chEx) chEx.destroy();
      chEx = new Chart(ctx,{
        type:"line",
        data:{labels,datasets:[
          {label:"Volume (kg·reps)",data:vol},
          {label:"Carga máxima (kg)",data:maxLoad}
        ]},
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
      });
    };

    // ---------- Backup / Restore ----------
    document.getElementById("btnExport").onclick = ()=>{
      const blob = new Blob([JSON.stringify(getData(),null,2)],{type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "treinos_backup.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };
    document.getElementById("btnImport").onclick = ()=> document.getElementById("importFile").click();
    document.getElementById("importFile").addEventListener("change", (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const arr = JSON.parse(reader.result);
          if(Array.isArray(arr)){ setData(arr); renderHistorico(); renderDash(); alert("Dados importados!"); }
          else alert("Arquivo inválido.");
        }catch(err){ alert("Erro ao ler JSON."); }
      };
      reader.readAsText(f);
    });

    // ---------- Inicialização ----------
    renderHistorico(); renderDash();
  </script>
</body>
</html>
