<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Plano de Treino – 4 Semanas (Firebase)</title>
  <style>
    :root{--azul:#4a90e2;--cinza:#f7f7f7;--borda:#d0d0d0;}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--cinza);color:#222}
    header{padding:14px;background:#fff;border-bottom:1px solid var(--borda);display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:1.15rem}
    main{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--borda);border-radius:10px;padding:16px;margin-bottom:18px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #bbb;padding:8px;vertical-align:top}
    th{background:var(--azul);color:#fff}
    .btn{background:var(--azul);color:#fff;border:none;border-radius:6px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-outline{background:#fff;color:var(--azul);border:1px solid var(--azul)}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    label{font-weight:600;margin-top:8px;display:block}
    input,select,textarea{width:100%;padding:9px;border:1px solid #ccc;border-radius:6px;margin-top:6px}
    textarea{min-height:90px}
    .muted{color:#666;font-size:.9rem}
    .activity{border-bottom:1px dashed #ddd;padding:8px 0}
    .chip{display:inline-block;padding:3px 8px;border-radius:18px;background:#eef3ff;color:#2c5bbf;margin-right:6px;font-size:.85rem}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .danger{color:#b00020}
    .ok{color:#0c7a35}
    .center{text-align:center}
    .hidden{display:none}
    @media(max-width:800px){.grid-2,.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>📊 Plano de Treino – 4 Semanas (Firebase)</h1>
    <div class="row">
      <span id="userInfo" class="muted">Deslogado</span>
      <button id="btnLogin" class="btn">Entrar com Google</button>
      <button id="btnLogout" class="btn btn-outline hidden">Sair</button>
    </div>
  </header>

  <main>
    <!-- PLANO (referência) -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Plano (referência)</h2>
        <div class="row">
          <button class="btn" id="btnAdd">➕ Adicionar atividade</button>
          <button class="btn btn-outline" id="btnExport">Backup (JSON)</button>
          <label class="btn btn-outline">
            Importar <input type="file" id="importFile" accept="application/json" style="display:none">
          </label>
        </div>
      </div>
      <div class="muted">Os dados ficam na sua conta (Firestore). Faça login para registrar/visualizar.</div>
      <div style="overflow:auto;margin-top:10px">
        <table>
          <tr>
            <th>Semana</th>
            <th>Dia A – Ombro + Peito</th>
            <th>Dia B – Costas + Bíceps</th>
            <th>Dia C – Pernas + Tríceps + Core</th>
          </tr>
          <tr>
            <td>1 – Adaptação</td>
            <td>Rot. ext/int 3x12–15; Elevação lat 3x12–15; Desenvolv. 2x12–15; Supino 2x12–15; Flexão 2x falha</td>
            <td>Remada 3x12–15; Puxada 3x12–15; Face pull 3x12–15; Rosca direta 2x12–15; Rosca martelo 2x12–15</td>
            <td>Agacha 3x12–15; Afundo 2x12–15; Terra romeno 2x12–15; Tríceps testa 2x12–15; Mergulho 2x falha; Prancha 3x30s; Infra 3x12–15</td>
          </tr>
          <tr>
            <td>2 – Consolidação</td>
            <td>Rot. ext/int 3x12; Elevação lat 3x12; Desenvolv. 3x10–12; Supino 3x10–12; Flexão 3x falha</td>
            <td>Remada 3x10–12; Puxada 3x10–12; Face pull 3x12; Rosca direta 3x10–12; Rosca martelo 3x10–12</td>
            <td>Agacha 3x10–12; Afundo 3x10–12; Terra romeno 3x10–12; Tríceps testa 3x10–12; Mergulho 3x falha; Prancha 3x35s; Infra 3x12</td>
          </tr>
          <tr>
            <td>3 – Progressão</td>
            <td>Rot. ext/int 3x12; Elevação lat 4x10; Desenvolv. 4x8–10; Supino 4x8–10; Flexão 3x falha</td>
            <td>Remada 4x8–10; Puxada 4x8–10; Face pull 3x12; Rosca direta 3x10; Rosca martelo 3x10</td>
            <td>Agacha 4x8–10; Afundo 3x10; Terra romeno 3x8–10; Tríceps testa 3x10; Mergulho 3x falha; Prancha 3x40s; Infra 3x12</td>
          </tr>
          <tr>
            <td>4 – Choque</td>
            <td>Rot. ext/int 3x15; Elevação lat 4x12 (drop); Desenvolv. 4x10–12 (drop); Supino 4x10–12 (drop); Flexão 4x falha</td>
            <td>Remada 4x10–12 (drop); Puxada 4x10–12 (drop); Face pull 4x12; Rosca direta 4x12 (drop); Rosca martelo 4x12</td>
            <td>Agacha 4x10–12 (drop); Afundo 3x12; Terra romeno 4x10; Tríceps testa 4x12 (drop); Mergulho 4x falha; Prancha 3x45s; Infra 3x15</td>
          </tr>
        </table>
      </div>
    </section>

    <!-- FORMULÁRIO -->
    <section class="card hidden" id="formCard">
      <h2 style="margin-top:0" id="formTitle">Nova atividade</h2>
      <div class="grid grid-3">
        <div>
          <label for="fase">Fase (semana)</label>
          <select id="fase">
            <option>Semana 1</option><option>Semana 2</option>
            <option>Semana 3</option><option>Semana 4</option>
          </select>
        </div>
        <div>
          <label for="grupo">Grupo muscular</label>
          <select id="grupo">
            <option>Ombro + Peito</option>
            <option>Costas + Bíceps</option>
            <option>Pernas + Tríceps + Core</option>
          </select>
        </div>
        <div>
          <label for="data">Data</label>
          <input type="date" id="data"/>
        </div>
      </div>

      <h3>Séries do dia</h3>
      <div id="setsWrap"></div>
      <button class="btn btn-outline" id="btnAddSet" type="button">+ Adicionar exercício</button>

      <label for="obs">Observações</label>
      <textarea id="obs" placeholder="Como se sentiu? Técnica? Sono/energia?"></textarea>

      <div style="margin-top:12px" class="row">
        <button class="btn" id="btnSave">Concluir e salvar</button>
        <button class="btn btn-outline" id="btnCancel" type="button">Cancelar</button>
      </div>
    </section>

    <!-- HISTÓRICO -->
    <section class="card">
      <h2 style="margin-top:0">Histórico</h2>
      <div id="listaAtividades"></div>
    </section>

    <!-- DASHBOARD -->
    <section class="card">
      <h2 style="margin-top:0">📈 Dashboard</h2>
      <div class="grid grid-2">
        <div>
          <h3 class="center" style="margin:4px 0">Treinos por semana</h3>
          <canvas id="chartSemanas" height="220"></canvas>
        </div>
        <div>
          <h3 class="center" style="margin:4px 0">Volume por grupo (kg·reps)</h3>
          <canvas id="chartGrupos" height="220"></canvas>
        </div>
      </div>
      <div class="grid grid-2" style="margin-top:16px">
        <div>
          <h3 class="center" style="margin:4px 0">Tendência de um exercício</h3>
          <div class="row" style="gap:10px;margin-bottom:6px">
            <input id="filterEx" placeholder="Ex.: Supino reto"/>
            <button class="btn btn-outline" id="btnFiltrar">Plotar</button>
          </div>
          <canvas id="chartExercicio" height="220"></canvas>
          <div class="muted">Use o nome exatamente como registrou.</div>
        </div>
        <div>
          <h3 class="center" style="margin:4px 0">Estatísticas</h3>
          <div id="stats"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase SDKs (modular) -->
  <script type="module">
    /* ===========================
       1) CONFIGURE SEU FIREBASE
       =========================== */
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDmxVS3YbIEZ6E6E6pYnlqEYSnlh2-1-c0",
  authDomain: "mrovere-treino.firebaseapp.com",
  projectId: "mrovere-treino",
  storageBucket: "mrovere-treino.firebasestorage.app",
  messagingSenderId: "699941554235",
  appId: "1:699941554235:web:e96bc21c9fd6dd2df0341e",
  measurementId: "G-CXP4VQKETF"
};

    /* ===========================
       2) IMPORTS E INIT
       =========================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {
      getFirestore, enableIndexedDbPersistence,
      collection, addDoc, getDocs, query, orderBy,
      updateDoc, doc, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{ /* alguns modos privados não suportam */ });

    /* ===========================
       3) ESTADO E HELPERS
       =========================== */
    let UID = null;
    let editingId = null;
    let chSemanas, chGrupos, chEx;

    const $ = (sel) => document.querySelector(sel);
    const byId = (id) => document.getElementById(id);
    const fmtDate = (iso) => !iso ? "" : new Date(iso+"T00:00:00").toLocaleDateString("pt-BR");
    const weekKey = (iso) => {
      const d=new Date(iso+"T00:00:00"), onejan=new Date(d.getFullYear(),0,1);
      return d.getFullYear()+"-S"+String(Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7)).padStart(2,"0");
    };
    const sum = (a)=>a.reduce((x,y)=>x+y,0);

    function calcVolume(activity){
      let total=0;
      (activity.sets||[]).forEach(s=>{
        (s.series||[]).forEach(x=>{
          total += (Number(x.reps)||0) * (Number(x.carga)||0);
        });
      });
      return total;
    }

    /* ===========================
       4) AUTH (login/logout)
       =========================== */
    const userInfo = byId("userInfo");
    const btnLogin = byId("btnLogin");
    const btnLogout= byId("btnLogout");

    btnLogin.onclick = async ()=>{
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    };
    btnLogout.onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        UID = user.uid;
        userInfo.textContent = `Olá, ${user.displayName || user.email}`;
        btnLogin.classList.add("hidden");
        btnLogout.classList.remove("hidden");
        await renderHistorico();
        renderDash();
      }else{
        UID = null;
        userInfo.textContent = "Deslogado";
        btnLogin.classList.remove("hidden");
        btnLogout.classList.add("hidden");
        $("#listaAtividades").innerHTML = '<div class="muted">Entre com Google para ver/registrar seus treinos.</div>';
        resetCharts();
      }
    });

    function resetCharts(){
      if(chSemanas) chSemanas.destroy();
      if(chGrupos)  chGrupos.destroy();
      if(chEx)      chEx.destroy();
    }

    /* ===========================
       5) FORM DINÂMICO
       =========================== */
    const formCard = byId("formCard");
    const setsWrap = byId("setsWrap");

    byId("btnAdd").onclick = ()=>{
      if(!UID){ alert("Entre com Google para adicionar atividades."); return; }
      openForm(); // novo
    };
    byId("btnCancel").onclick = closeForm;
    byId("btnAddSet").onclick = ()=> addSetRow();

    function openForm(activity=null){
      formCard.classList.remove("hidden");
      byId("formTitle").textContent = activity ? "Editar atividade" : "Nova atividade";
      byId("fase").value = activity?.fase || "Semana 1";
      byId("grupo").value = activity?.grupo || "Ombro + Peito";
      byId("data").value = activity?.data || new Date().toISOString().slice(0,10);
      byId("obs").value  = activity?.obs || "";
      setsWrap.innerHTML = "";
      (activity?.sets?.length ? activity.sets : [{exercicio:"",series:[{reps:"",carga:""}]}]).forEach(s=>{
        addSetRow(s);
      });
      editingId = activity?.id || null;
    }
    function closeForm(){
      formCard.classList.add("hidden");
      setsWrap.innerHTML = "";
      byId("obs").value="";
      editingId = null;
    }
    function addSetRow(prefill={exercicio:"",series:[{reps:"",carga:""}]}){
      const block = document.createElement("div");
      block.className="card";
      block.style.padding="12px";
      block.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div style="flex:1">
            <label>Exercício</label>
            <input class="exNome" placeholder="Ex.: Supino reto" value="${prefill.exercicio||""}">
          </div>
          <button class="btn btn-outline" type="button">Remover</button>
        </div>
        <div class="seriesWrap"></div>
        <button class="btn btn-outline" type="button">+ Série</button>
      `;
      const seriesWrap = block.querySelector(".seriesWrap");
      const btnDel = block.querySelector(".btn.btn-outline");
      const btnAddSerie = block.querySelectorAll(".btn.btn-outline")[1];
      btnDel.onclick = ()=> block.remove();
      btnAddSerie.onclick = ()=> addSerieRow(seriesWrap);
      (prefill.series||[{reps:"",carga:""}]).forEach(s=> addSerieRow(seriesWrap, s));
      setsWrap.appendChild(block);
    }
    function addSerieRow(container, s={reps:"",carga:""}){
      const row = document.createElement("div");
      row.className="row";
      row.style.marginTop="8px";
      row.innerHTML = `
        <label style="min-width:64px">Reps</label>
        <input class="reps" type="number" min="0" style="max-width:110px" value="${s.reps||""}">
        <label style="min-width:90px">Carga (kg)</label>
        <input class="carga" type="number" min="0" step="0.5" style="max-width:120px" value="${s.carga||""}">
        <button class="btn btn-outline" type="button">–</button>
      `;
      row.querySelector("button").onclick = ()=> row.remove();
      container.appendChild(row);
    }

    /* ===========================
       6) FIRESTORE CRUD
       =========================== */
    async function fetchActivities(){
      if(!UID) return [];
      const qRef = query(collection(db,"users",UID,"activities"), orderBy("data","desc"));
      const snap = await getDocs(qRef);
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }
    async function addActivity(payload){
      if(!UID) throw new Error("Login necessário");
      payload.createdAt = serverTimestamp();
      payload.updatedAt = serverTimestamp();
      await addDoc(collection(db,"users",UID,"activities"), payload);
    }
    async function updateActivity(id, payload){
      payload.updatedAt = serverTimestamp();
      await updateDoc(doc(db,"users",UID,"activities",id), payload);
    }
    async function deleteActivity(id){
      await deleteDoc(doc(db,"users",UID,"activities",id));
    }

    // Salvar (criar/editar)
    byId("btnSave").onclick = async ()=>{
      if(!UID){ alert("Faça login."); return; }
      const fase = byId("fase").value;
      const grupo= byId("grupo").value;
      const data = byId("data").value;
      const obs  = byId("obs").value;
      if(!data){ alert("Informe a data."); return; }

      const sets = Array.from(setsWrap.querySelectorAll(".card")).map(b=>{
        const exercicio = b.querySelector(".exNome").value.trim();
        const series = Array.from(b.querySelectorAll(".seriesWrap .row")).map(r=>{
          const reps  = Number(r.querySelector(".reps").value)||0;
          const carga = Number(r.querySelector(".carga").value)||0;
          return {reps, carga};
        }).filter(s=> s.reps>0 || s.carga>0);
        return {exercicio, series};
      }).filter(s=> s.exercicio && s.series.length);

      if(!sets.length){ alert("Adicione ao menos um exercício com séries."); return; }

      const payload = { data, fase, grupo, sets, obs, volume: calcVolume({sets}) };

      if(editingId){ await updateActivity(editingId, payload); }
      else         { await addActivity(payload); }

      closeForm();
      await renderHistorico();
      renderDash();
    };

    /* ===========================
       7) HISTÓRICO
       =========================== */
    async function renderHistorico(){
      const cont = byId("listaAtividades");
      cont.innerHTML = '<div class="muted">Carregando…</div>';

      const atividades = await fetchActivities();
      if(!atividades.length){ cont.innerHTML = '<div class="muted">Sem atividades ainda.</div>'; return; }

      cont.innerHTML = "";
      atividades.forEach(a=>{
        const volume = Number(a.volume ?? calcVolume(a));
        const el = document.createElement("div");
        el.className = "activity";
        el.innerHTML = `
          <div>
            <b>${fmtDate(a.data)}</b> · <span class="chip">${a.fase}</span> <span class="chip">${a.grupo}</span>
            <span class="right">
              <button class="btn btn-outline" data-edit="${a.id}">Editar</button>
              <button class="btn btn-outline danger" data-del="${a.id}">Excluir</button>
            </span>
          </div>
          <div class="muted">Volume: <b>${volume.toFixed(1)}</b> kg·reps</div>
          <div style="margin-top:6px">
            ${(a.sets||[]).map(s=>{
              const seriesTxt = (s.series||[]).map((x,i)=>`S${i+1}:${x.reps}x${x.carga}kg`).join(" · ");
              return `<div>• <b>${s.exercicio}</b> — ${seriesTxt}</div>`;
            }).join("")}
          </div>
          ${a.obs ? `<div class="muted" style="margin-top:6px">Obs: ${a.obs}</div>` : ""}
        `;
        el.querySelector(`[data-edit="${a.id}"]`).onclick = ()=> openForm(a);
        el.querySelector(`[data-del="${a.id}"]`).onclick = async ()=>{
          if(confirm("Excluir esta atividade?")){
            await deleteActivity(a.id);
            await renderHistorico(); renderDash();
          }
        };
        cont.appendChild(el);
      });
    }

    /* ===========================
       8) DASHBOARD (Chart.js)
       =========================== */
    async function renderDash(){
      if(!UID) return;
      const atividades = await fetchActivities();

      // Treinos por semana
      const porSemana = {};
      atividades.forEach(a=>{
        const wk = weekKey(a.data);
        porSemana[wk] = (porSemana[wk]||0)+1;
      });
      const sLabels = Object.keys(porSemana).sort();
      const sVals   = sLabels.map(k=>porSemana[k]);

      // Volume por grupo
      const porGrupo = {};
      atividades.forEach(a=>{
        const vol = Number(a.volume ?? calcVolume(a));
        porGrupo[a.grupo] = (porGrupo[a.grupo]||0) + vol;
      });
      const gLabels = Object.keys(porGrupo);
      const gVals   = gLabels.map(k=>porGrupo[k]);

      // Stats
      const total  = atividades.length;
      const totalV = atividades.reduce((t,a)=> t + Number(a.volume ?? calcVolume(a)), 0);
      const ultimo = atividades.slice().sort((a,b)=> a.data<b.data?1:-1)[0];
      byId("stats").innerHTML = `
        <div><b>Total de treinos:</b> ${total}</div>
        <div><b>Volume acumulado:</b> ${totalV.toFixed(1)} kg·reps</div>
        ${ultimo ? `<div><b>Último treino:</b> ${fmtDate(ultimo.data)} · <span class="chip">${ultimo.grupo}</span></div>` : ""}
      `;

      // Charts
      const ctxS = byId("chartSemanas").getContext("2d");
      const ctxG = byId("chartGrupos").getContext("2d");
      if(chSemanas) chSemanas.destroy();
      if(chGrupos)  chGrupos.destroy();

      chSemanas = new Chart(ctxS,{
        type:"bar",
        data:{ labels:sLabels, datasets:[{ label:"Treinos/semana", data:sVals }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
      chGrupos = new Chart(ctxG,{
        type:"pie",
        data:{ labels:gLabels, datasets:[{ label:"Volume (kg·reps)", data:gVals }] },
        options:{ responsive:true }
      });

      // Tendência por exercício
      byId("btnFiltrar").onclick = ()=>{
        const nome = (byId("filterEx").value||"").trim().toLowerCase();
        const ordered = atividades.slice().sort((a,b)=> a.data>b.data?1:-1);
        const labels=[], vol=[], maxLoad=[];
        ordered.forEach(a=>{
          let v=0, max=0;
          (a.sets||[]).forEach(s=>{
            if((s.exercicio||"").toLowerCase()===nome){
              (s.series||[]).forEach(x=>{
                v += (Number(x.reps)||0)*(Number(x.carga)||0);
                if((Number(x.carga)||0)>max) max = Number(x.carga)||0;
              });
            }
          });
          if(v>0){ labels.push(fmtDate(a.data)); vol.push(v); maxLoad.push(max); }
        });
        const ctx = byId("chartExercicio").getContext("2d");
        if(chEx) chEx.destroy();
        chEx = new Chart(ctx,{
          type:"line",
          data:{ labels, datasets:[
            {label:"Volume (kg·reps)",data:vol},
            {label:"Carga máxima (kg)",data:maxLoad}
          ]},
          options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
        });
      };
    }

    /* ===========================
       9) BACKUP / RESTORE
       =========================== */
    byId("btnExport").onclick = async ()=>{
      if(!UID){ alert("Faça login."); return; }
      const data = await fetchActivities();
      const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "treinos_backup.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };
    byId("importFile").addEventListener("change", async (e)=>{
      if(!UID){ alert("Faça login."); e.target.value=""; return; }
      const f=e.target.files[0]; if(!f) return;
      try{
        const text = await f.text();
        const arr  = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error("JSON inválido");
        for(const a of arr){
          const payload = {
            data:a.data, fase:a.fase, grupo:a.grupo, sets:a.sets||[],
            obs:a.obs||"", volume:Number(a.volume||0),
            createdAt: serverTimestamp(), updatedAt: serverTimestamp()
          };
          await addActivity(payload);
        }
        await renderHistorico(); renderDash();
        alert("Importação concluída!");
      }catch(err){ alert("Erro ao importar JSON."); }
      e.target.value="";
    });
  </script>
</body>
</html>
