<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Plano de Treino ‚Äì 4 Semanas</title>

  <!-- Fonts modernas -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Paleta vibrante e ‚Äúfuturista‚Äù */
      --bg-1:#0f1226;         /* fundo base escuro azulado */
      --bg-2:#14183b;         /* fundo cards transl√∫cidos */
      --txt:#e6e9ff;          /* texto principal */
      --muted:#b7bde6;        /* texto secund√°rio */
      --primary:#8b5cf6;      /* roxo el√©trico */
      --primary-2:#06b6d4;    /* ciano */
      --accent:#22d3ee;       /* ciano claro */
      --danger:#ff6b6b;
      --glass:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.15);
      --shadow: 0 8px 30px rgba(2,8,23,.35);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1b1f46 0%, transparent 60%),
        radial-gradient(1200px 800px at 110% 10%, #0a373f 0%, transparent 50%),
        linear-gradient(180deg,#0f1226 0%, #0b0e1f 100%);
      background-attachment: fixed;
    }

    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter:saturate(160%) blur(14px);
      background:linear-gradient(90deg, rgba(139,92,246,.15), rgba(34,211,238,.12)) ;
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    h1{margin:0; font-size:1.15rem; font-family:'Space Grotesk',sans-serif; letter-spacing:.3px}

    main{max-width:1100px; margin:24px auto; padding:0 16px}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:22px;
      margin-bottom:22px;
      box-shadow: var(--shadow);
    }

    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px}
    th,td{padding:10px; vertical-align:top}
    th{
      background:linear-gradient(90deg, rgba(139,92,246,.35), rgba(34,211,238,.35));
      color:#fff; text-align:left; font-weight:700; font-family:'Space Grotesk',sans-serif;
    }
    td{border-bottom:1px solid var(--border); color:var(--muted)}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .right{margin-left:auto}
    .muted{color:var(--muted)}

    /* Bot√µes com micro-anim e glow */
    .btn{
      position:relative;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      color:#081226;
      border:none; border-radius:12px;
      padding:10px 16px; cursor:pointer; font-weight:700; letter-spacing:.2px;
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      box-shadow: 0 6px 20px rgba(139,92,246,.35);
      will-change: transform, box-shadow;
    }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 10px 26px rgba(34,211,238,.4) }
    .btn:active{ transform:translateY(0) scale(.98) }
    .btn-outline{
      background:transparent; color:#dbeafe;
      border:1px solid rgba(147,197,253,.5);
      box-shadow:none;
    }
    .btn-outline:hover{
      filter:drop-shadow(0 0 10px rgba(147,197,253,.3));
      transform:translateY(-2px);
    }
    .btn-danger{ background:linear-gradient(90deg,#ef4444,#fb7185); color:#1b0b0b; }

    .chip{
      display:inline-block; padding:6px 10px; border-radius:999px;
      background:linear-gradient(90deg, rgba(139,92,246,.25), rgba(34,211,238,.25));
      color:#e9edff; font-size:.85rem; letter-spacing:.2px;
    }

    .activity{border-bottom:1px dashed var(--border); padding:10px 0}

    /* Modal (popup) glassmorphism */
    .modal-backdrop{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50;
      background:rgba(4,8,22,.55); backdrop-filter: blur(8px);
      padding:16px;
    }
    .modal{
      width:100%; max-width:780px; border-radius:20px;
      background: linear-gradient(180deg, rgba(17,24,39,.85), rgba(17,24,39,.75));
      border:1px solid var(--border); box-shadow:0 18px 60px rgba(0,0,0,.5); overflow:hidden;
      animation:pop .16s ease;
    }
    @keyframes pop{from{transform:scale(.98); opacity:.8} to{transform:scale(1); opacity:1}}
    .modal header{display:flex; align-items:center; gap:10px; padding:16px 18px; border-bottom:1px solid var(--border)}
    .modal .content{padding:18px}
    .modal .footer{padding:16px 18px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; background:rgba(255,255,255,.02)}

    .form-field label{display:block; font-weight:700; margin-bottom:6px; font-family:'Space Grotesk',sans-serif}
    .form-field select, .form-field input{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--border); background:rgba(255,255,255,.05); color:var(--txt);
      outline:none; transition:border .15s ease, box-shadow .15s ease;
    }
    .form-field select:focus, .form-field input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(34,211,238,.25) }

    .exercise-row{
      display:grid; grid-template-columns:1fr 140px 140px; gap:12px; align-items:center;
      padding:10px 0; border-bottom:1px dashed var(--border);
    }
    .exercise-row:last-child{border-bottom:none}

    /* Canvas charts fundo ‚Äúescuro‚Äù */
    canvas{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:14px; padding:10px}

    @media (max-width:780px){
      .exercise-row{grid-template-columns:1fr 1fr 1fr}
    }
  </style>
</head>
<body>
  <header>
    <h1>üèãÔ∏è Plano de Treino ‚Äì 4 Semanas</h1>
    <div class="row">
      <span id="userInfo" class="muted">Deslogado</span>
      <button id="btnLogin" class="btn">Entrar com Google</button>
      <button id="btnLogout" class="btn btn-outline" style="display:none">Sair</button>
    </div>
  </header>

  <main>
    <!-- PLANO (refer√™ncia) -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0; font-family:'Space Grotesk',sans-serif">Plano (refer√™ncia)</h2>
        <div class="row">
          <button class="btn" id="btnAdd">‚ûï Adicionar atividade</button>
          <button class="btn btn-outline" id="btnExport">Backup (JSON)</button>
          <label class="btn btn-outline" style="cursor:pointer">
            Importar <input type="file" id="importFile" accept="application/json" style="display:none">
          </label>
        </div>
      </div>
      <div class="muted">Fa√ßa login para registrar/visualizar suas atividades. Seus dados ficam no Firestore da sua conta.</div>
      <div style="overflow:auto;margin-top:14px">
        <table>
          <tr>
            <th>Semana</th>
            <th>Dia A ‚Äì Ombro + Peito</th>
            <th>Dia B ‚Äì Costas + B√≠ceps</th>
            <th>Dia C ‚Äì Pernas + Tr√≠ceps + Core</th>
          </tr>
          <tr>
            <td>1 ‚Äì Adapta√ß√£o</td>
            <td>Rot. ext/int 3x12‚Äì15; Eleva√ß√£o lat 3x12‚Äì15; Desenvolv. 2x12‚Äì15; Supino 2x12‚Äì15; Flex√£o 2x falha</td>
            <td>Remada 3x12‚Äì15; Puxada 3x12‚Äì15; Face pull 3x12‚Äì15; Rosca direta 2x12‚Äì15; Rosca martelo 2x12‚Äì15</td>
            <td>Agacha 3x12‚Äì15; Afundo 2x12‚Äì15; Terra romeno 2x12‚Äì15; Tr√≠ceps testa 2x12‚Äì15; Mergulho 2x falha; Prancha 3x30s; Infra 3x12‚Äì15</td>
          </tr>
          <tr>
            <td>2 ‚Äì Consolida√ß√£o</td>
            <td>Rot. ext/int 3x12; Eleva√ß√£o lat 3x12; Desenvolv. 3x10‚Äì12; Supino 3x10‚Äì12; Flex√£o 3x falha</td>
            <td>Remada 3x10‚Äì12; Puxada 3x10‚Äì12; Face pull 3x12; Rosca direta 3x10‚Äì12; Rosca martelo 3x10‚Äì12</td>
            <td>Agacha 3x10‚Äì12; Afundo 3x10‚Äì12; Terra romeno 3x10‚Äì12; Tr√≠ceps testa 3x10‚Äì12; Mergulho 3x falha; Prancha 3x35s; Infra 3x12</td>
          </tr>
          <tr>
            <td>3 ‚Äì Progress√£o</td>
            <td>Rot. ext/int 3x12; Eleva√ß√£o lat 4x10; Desenvolv. 4x8‚Äì10; Supino 4x8‚Äì10; Flex√£o 3x falha</td>
            <td>Remada 4x8‚Äì10; Puxada 4x8‚Äì10; Face pull 3x12; Rosca direta 3x10; Rosca martelo 3x10</td>
            <td>Agacha 4x8‚Äì10; Afundo 3x10; Terra romeno 3x8‚Äì10; Tr√≠ceps testa 3x10; Mergulho 3x falha; Prancha 3x40s; Infra 3x12</td>
          </tr>
          <tr>
            <td>4 ‚Äì Choque</td>
            <td>Rot. ext/int 3x15; Eleva√ß√£o lat 4x12 (drop); Desenvolv. 4x10‚Äì12 (drop); Supino 4x10‚Äì12 (drop); Flex√£o 4x falha</td>
            <td>Remada 4x10‚Äì12 (drop); Puxada 4x10‚Äì12 (drop); Face pull 4x12; Rosca direta 4x12 (drop); Rosca martelo 4x12</td>
            <td>Agacha 4x10‚Äì12 (drop); Afundo 3x12; Terra romeno 4x10; Tr√≠ceps testa 4x12 (drop); Mergulho 4x falha; Prancha 3x45s; Infra 3x15</td>
          </tr>
        </table>
      </div>
    </section>

    <!-- HIST√ìRICO -->
    <section class="card">
      <h2 style="margin-top:0; font-family:'Space Grotesk',sans-serif">Hist√≥rico</h2>
      <div id="listaAtividades"></div>
    </section>

    <!-- DASHBOARD -->
    <section class="card">
      <h2 style="margin-top:0; font-family:'Space Grotesk',sans-serif">üìà Dashboard</h2>
      <div class="row" style="margin-bottom:10px">
        <span class="chip">Treinos por semana</span>
        <span class="chip">Volume por grupo</span>
      </div>
      <div class="row" style="gap:16px; flex-wrap:wrap">
        <canvas id="chartSemanas" height="220" style="flex:1 1 360px"></canvas>
        <canvas id="chartGrupos"  height="220" style="flex:1 1 360px"></canvas>
      </div>
      <div class="row" style="margin-top:16px; gap:16px; flex-wrap:wrap">
        <div style="flex:1 1 360px">
          <h3 class="muted" style="margin:6px 0 8px">Tend√™ncia de um exerc√≠cio</h3>
          <div class="row" style="gap:10px;margin-bottom:8px">
            <input id="filterEx" placeholder="Ex.: Supino reto" class="form-input" style="flex:1; padding:10px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:var(--txt)">
            <button class="btn btn-outline" id="btnFiltrar">Plotar</button>
          </div>
          <canvas id="chartExercicio" height="220"></canvas>
        </div>
        <div style="flex:1 1 260px">
          <h3 class="muted" style="margin:6px 0 8px">Estat√≠sticas</h3>
          <div id="stats"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: adicionar atividade -->
  <div class="modal-backdrop" id="modalAdd">
    <div class="modal">
      <header>
        <h3 style="margin:0; font-family:'Space Grotesk',sans-serif">Adicionar atividade</h3>
        <span class="chip">Marque conclu√≠dos e adicione peso (kg)</span>
        <button class="btn btn-outline right" id="btnCloseModal">Fechar</button>
      </header>
      <div class="content">
        <div class="row" style="gap:14px; flex-wrap:wrap">
          <div class="form-field" style="flex:1 1 220px">
            <label>Semana</label>
            <select id="selSemana">
              <option>Semana 1</option>
              <option>Semana 2</option>
              <option>Semana 3</option>
              <option>Semana 4</option>
            </select>
          </div>
          <div class="form-field" style="flex:1 1 220px">
            <label>Dia</label>
            <select id="selDia">
              <option value="A">Dia A (Ombro + Peito)</option>
              <option value="B">Dia B (Costas + B√≠ceps)</option>
              <option value="C">Dia C (Pernas + Tr√≠ceps + Core)</option>
            </select>
          </div>
          <div class="form-field" style="flex:1 1 220px">
            <label>Data</label>
            <input type="date" id="selData">
          </div>
        </div>

        <div id="exerciseList" style="margin-top:12px"></div>

        <div class="form-field" style="margin-top:12px">
          <label>Observa√ß√µes</label>
          <input id="inpObs" placeholder="Como se sentiu? Observa√ß√µes do dia.">
        </div>
      </div>
      <div class="footer">
        <button class="btn btn-outline" id="btnClearModal">Limpar</button>
        <button class="btn" id="btnSaveModal">Concluir e salvar</button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase SDKs (modular) + App -->
  <script type="module">
    /* =======================
       Firebase Config (seu)
       ======================= */
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyDmxVS3YbIEZ6E6E6pYnlqEYSnlh2-1-c0",
      authDomain: "mrovere-treino.firebaseapp.com",
      projectId: "mrovere-treino",
      storageBucket: "mrovere-treino.firebasestorage.app",
      messagingSenderId: "699941554235",
      appId: "1:699941554235:web:e96bc21c9fd6dd2df0341e",
      measurementId: "G-CXP4VQKETF"
    };

    /* ============ Imports/Init ============ */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      setPersistence, browserLocalPersistence,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {
      getFirestore, enableIndexedDbPersistence,
      collection, addDoc, getDocs, query, orderBy,
      updateDoc, doc, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{});
    await setPersistence(auth, browserLocalPersistence);

    /* ============ Estado/Helpers ============ */
    let UID = null, chSemanas, chGrupos, chEx;
    const $ = s=>document.querySelector(s), byId=id=>document.getElementById(id);
    const fmtDate = iso => !iso ? "" : new Date(iso+"T00:00:00").toLocaleDateString("pt-BR");
    const todayISO = () => new Date().toISOString().slice(0,10);
    const weekKey = iso => { const d=new Date(iso+"T00:00:00"), one=new Date(d.getFullYear(),0,1); return d.getFullYear()+"-S"+String(Math.ceil((((d-one)/86400000)+one.getDay()+1)/7)).padStart(2,"0"); };
    const sum = a=>a.reduce((x,y)=>x+y,0);

    // Plano base (exerc√≠cios por semana/dia)
    const PLAN = {
      "Semana 1": {
        A: ["Rota√ß√£o externa/interna","Eleva√ß√£o lateral","Desenvolvimento","Supino reto","Flex√£o de bra√ßo"],
        B: ["Remada curvada","Puxada na frente","Face pull","Rosca direta","Rosca martelo"],
        C: ["Agachamento","Afundo","Terra romeno","Tr√≠ceps testa","Mergulho banco","Prancha","Abdominal infra"]
      },
      "Semana 2": {
        A: ["Rota√ß√£o externa/interna","Eleva√ß√£o lateral","Desenvolvimento","Supino reto","Flex√£o de bra√ßo"],
        B: ["Remada curvada","Puxada na frente","Face pull","Rosca direta","Rosca martelo"],
        C: ["Agachamento","Afundo","Terra romeno","Tr√≠ceps testa","Mergulho banco","Prancha","Abdominal infra"]
      },
      "Semana 3": {
        A: ["Rota√ß√£o externa/interna","Eleva√ß√£o lateral","Desenvolvimento","Supino reto","Flex√£o de bra√ßo"],
        B: ["Remada curvada","Puxada na frente","Face pull","Rosca direta","Rosca martelo"],
        C: ["Agachamento","Afundo","Terra romeno","Tr√≠ceps testa","Mergulho banco","Prancha","Abdominal infra"]
      },
      "Semana 4": {
        A: ["Rota√ß√£o externa/interna","Eleva√ß√£o lateral","Desenvolvimento","Supino reto","Flex√£o de bra√ßo"],
        B: ["Remada curvada","Puxada na frente","Face pull","Rosca direta","Rosca martelo"],
        C: ["Agachamento","Afundo","Terra romeno","Tr√≠ceps testa","Mergulho banco","Prancha","Abdominal infra"]
      }
    };
    const DIA_TO_GRUPO = { A:"Ombro + Peito", B:"Costas + B√≠ceps", C:"Pernas + Tr√≠ceps + Core" };

    /* ============ Auth (popup/redirect) ============ */
    const userInfo=byId("userInfo"), btnLogin=byId("btnLogin"), btnLogout=byId("btnLogout");
    function isSafariOrIOS(){ const ua=navigator.userAgent; return /iPhone|iPad|iPod/i.test(ua) || /^((?!chrome|android).)*safari/i.test(ua); }
    btnLogin.onclick = async ()=>{
      try{
        const provider = new GoogleAuthProvider();
        if(isSafariOrIOS()) await signInWithRedirect(auth, provider);
        else await signInWithPopup(auth, provider);
      }catch(e){ alert(`Erro de login: ${e.code||e.message}`); }
    };
    btnLogout.onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        UID = user.uid;
        userInfo.textContent = `Ol√°, ${user.displayName || user.email}`;
        btnLogin.style.display="none"; btnLogout.style.display="inline-block";
        await renderHistorico(); renderDash();
      }else{
        UID = null;
        userInfo.textContent = "Deslogado";
        btnLogin.style.display="inline-block"; btnLogout.style.display="none";
        byId("listaAtividades").innerHTML = '<div class="muted">Entre com Google para ver/registrar seus treinos.</div>';
        if(chSemanas) chSemanas.destroy(); if(chGrupos) chGrupos.destroy(); if(chEx) chEx.destroy();
      }
    });

    /* ============ Firestore CRUD ============ */
    async function fetchActivities(){
      if(!UID) return [];
      const qRef = query(collection(db,"users",UID,"activities"), orderBy("data","desc"));
      const snap = await getDocs(qRef);
      return snap.docs.map(d=>({id:d.id, ...d.data()}));
    }
    async function addActivity(payload){
      payload.createdAt = serverTimestamp(); payload.updatedAt = serverTimestamp();
      await addDoc(collection(db,"users",UID,"activities"), payload);
    }
    async function deleteActivity(id){ await deleteDoc(doc(db,"users",UID,"activities",id)); }

    function calcVolumeBySets(sets){
      // volume simples: soma das cargas (sem reps) dos exerc√≠cios marcados
      return (sets||[]).reduce((t,s)=> t + Number(s.series?.[0]?.carga||0), 0);
    }

    /* ============ Modal (Adicionar atividade) ============ */
    const modal = byId("modalAdd"), btnAdd=byId("btnAdd"), btnCloseModal=byId("btnCloseModal");
    const selSemana=byId("selSemana"), selDia=byId("selDia"), selData=byId("selData");
    const exerciseList=byId("exerciseList"), btnSaveModal=byId("btnSaveModal"), btnClearModal=byId("btnClearModal"), inpObs=byId("inpObs");

    function openModal(){
      if(!UID){ alert("Entre com Google para adicionar atividades."); return; }
      modal.style.display = "flex";
      selData.value = todayISO();
      renderExercises();
    }
    function closeModal(){ modal.style.display="none"; exerciseList.innerHTML=""; inpObs.value=""; }
    function renderExercises(){
      const semana = selSemana.value, dia = selDia.value;
      const list = PLAN[semana]?.[dia] || [];
      exerciseList.innerHTML = "";
      if(!list.length){ exerciseList.innerHTML = '<div class="muted">Sem exerc√≠cios para esta combina√ß√£o.</div>'; return; }
      list.forEach(name=>{
        const row = document.createElement("div");
        row.className = "exercise-row";
        row.innerHTML = `
          <div style="font-family:'Space Grotesk',sans-serif"><strong>${name}</strong></div>
          <div><input type="number" min="0" step="0.5" placeholder="Peso (kg)" data-weight class="form-input"></div>
          <div class="row"><input type="checkbox" data-done id="chk-${name}"><label for="chk-${name}" class="muted">Conclu√≠do</label></div>
        `;
        exerciseList.appendChild(row);
      });
    }
    btnAdd.onclick = openModal;
    btnCloseModal.onclick = closeModal;
    btnClearModal.onclick = ()=>{ exerciseList.querySelectorAll('input[type="number"]').forEach(i=>i.value=""); exerciseList.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false); };
    selSemana.onchange = renderExercises; selDia.onchange = renderExercises;

    btnSaveModal.onclick = async ()=>{
      if(!UID){ alert("Fa√ßa login."); return; }
      const fase = selSemana.value;
      const dia  = selDia.value;
      const grupo= DIA_TO_GRUPO[dia] || "";
      const data = selData.value || todayISO();
      const obs  = inpObs.value || "";

      const rows = Array.from(exerciseList.querySelectorAll(".exercise-row"));
      const sets = rows.map(r=>{
        const name = r.querySelector("strong").textContent;
        const carga = Number(r.querySelector('[data-weight]').value) || 0;
        const done  = r.querySelector('[data-done]').checked;
        return { exercicio:name, done, series:[{ reps:0, carga }] };
      }).filter(s=> s.done || (s.series?.[0]?.carga||0) > 0);

      if(!sets.length){ alert("Preencha ao menos um peso ou marque algum exerc√≠cio como conclu√≠do."); return; }

      const volume = calcVolumeBySets(sets);
      const payload = { data, fase, grupo, sets, obs, volume };
      await addActivity(payload);
      closeModal();
      await renderHistorico(); renderDash();
    };

    /* ============ Hist√≥rico ============ */
    async function renderHistorico(){
      const cont = byId("listaAtividades");
      cont.innerHTML = '<div class="muted">Carregando‚Ä¶</div>';
      const atividades = await fetchActivities();
      if(!atividades.length){ cont.innerHTML = '<div class="muted">Sem atividades ainda.</div>'; return; }
      cont.innerHTML = "";
      atividades.forEach(a=>{
        const vol = Number(a.volume||0);
        const el = document.createElement("div");
        el.className="activity";
        el.innerHTML = `
          <div>
            <b>${fmtDate(a.data)}</b> ¬∑ <span class="chip">${a.fase}</span> <span class="chip">${a.grupo}</span>
            <span class="right">
              <button class="btn btn-outline btn-danger" data-del="${a.id}">Excluir</button>
            </span>
          </div>
          <div class="muted">Volume (kg): <b>${vol.toFixed(1)}</b></div>
          <div style="margin-top:6px">
            ${(a.sets||[]).map(s=>{
              const carga = s.series?.[0]?.carga ?? 0;
              const done  = s.done ? "‚úÖ" : "‚¨úÔ∏è";
              return `<div>‚Ä¢ ${done} <b>${s.exercicio}</b> ‚Äî ${carga} kg</div>`;
            }).join("")}
          </div>
          ${a.obs ? `<div class="muted" style="margin-top:6px">Obs: ${a.obs}</div>` : ""}
        `;
        el.querySelector(`[data-del="${a.id}"]`).onclick = async ()=>{
          if(confirm("Excluir esta atividade?")){ await deleteActivity(a.id); await renderHistorico(); renderDash(); }
        };
        cont.appendChild(el);
      });
    }

    /* ============ Dashboard (Chart.js) ============ */
    function palette(n){
      const base = ['#8b5cf6','#06b6d4','#10b981','#f59e0b','#ef4444','#22d3ee','#a78bfa','#34d399'];
      const arr=[]; for(let i=0;i<n;i++) arr.push(base[i%base.length]); return arr;
    }

    async function renderDash(){
      if(!UID) return;
      const atividades = await fetchActivities();

      const porSemana = {};
      atividades.forEach(a=>{ const wk=weekKey(a.data); porSemana[wk]=(porSemana[wk]||0)+1; });
      const sLabels = Object.keys(porSemana).sort();
      const sVals   = sLabels.map(k=>porSemana[k]);

      const porGrupo = {};
      atividades.forEach(a=>{ porGrupo[a.grupo]=(porGrupo[a.grupo]||0)+Number(a.volume||0); });
      const gLabels = Object.keys(porGrupo);
      const gVals   = gLabels.map(k=>porGrupo[k]);

      const total = atividades.length;
      const totalV= atividades.reduce((t,a)=>t+Number(a.volume||0),0);
      const ultimo= atividades.slice().sort((a,b)=> a.data<b.data?1:-1)[0];
      byId("stats").innerHTML = `
        <div><b>Total de treinos:</b> ${total}</div>
        <div><b>Volume acumulado (kg):</b> ${totalV.toFixed(1)}</div>
        ${ultimo ? `<div><b>√öltimo treino:</b> ${fmtDate(ultimo.data)} ¬∑ <span class="chip">${ultimo.grupo}</span></div>` : ""}
      `;

      const ctxS = byId("chartSemanas").getContext("2d");
      const ctxG = byId("chartGrupos").getContext("2d");
      if(chSemanas) chSemanas.destroy(); if(chGrupos) chGrupos.destroy();

      chSemanas = new Chart(ctxS,{
        type:"bar",
        data:{ labels:sLabels, datasets:[{ label:"Treinos/semana", data:sVals, backgroundColor:palette(sVals.length)}] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, ticks:{color:'#c7d2fe'}}, x:{ticks:{color:'#c7d2fe'}}}, plugins:{legend:{labels:{color:'#e2e8f0'}}}}
      });
      chGrupos  = new Chart(ctxG,{
        type:"pie",
        data:{ labels:gLabels, datasets:[{ label:"Volume (kg)", data:gVals, backgroundColor:palette(gVals.length)}] },
        options:{ responsive:true, plugins:{legend:{labels:{color:'#e2e8f0'}}}}
      });

      // Tend√™ncia por exerc√≠cio
      byId("btnFiltrar").onclick = ()=>{
        const nome = (byId("filterEx").value||"").trim().toLowerCase();
        const ordered = atividades.slice().sort((a,b)=> a.data>b.data?1:-1);
        const labels=[], vol=[], maxLoad=[];
        ordered.forEach(a=>{
          let v=0, max=0;
          (a.sets||[]).forEach(s=>{
            if((s.exercicio||"").toLowerCase()===nome){
              const carga = Number(s.series?.[0]?.carga||0);
              v += carga; if(carga>max) max=carga;
            }
          });
          if(v>0){ labels.push(fmtDate(a.data)); vol.push(v); maxLoad.push(max); }
        });
        const ctx = byId("chartExercicio").getContext("2d");
        if(chEx) chEx.destroy();
        chEx = new Chart(ctx,{
          type:"line",
          data:{ labels, datasets:[
            {label:"Soma das cargas (kg)",data:vol, borderColor:"#22d3ee"},
            {label:"Carga m√°xima (kg)",data:maxLoad, borderColor:"#a78bfa"}
          ]},
          options:{ responsive:true, scales:{ y:{ beginAtZero:true, ticks:{color:'#c7d2fe'}}, x:{ticks:{color:'#c7d2fe'}}}, plugins:{legend:{labels:{color:'#e2e8f0'}}}}
        });
      };
    }

    /* ============ Backup / Restore ============ */
    byId("btnExport").onclick = async ()=>{
      if(!UID){ alert("Fa√ßa login."); return; }
      const data = await fetchActivities();
      const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "treinos_backup.json"; a.click();
      URL.revokeObjectURL(a.href);
    };
    byId("importFile").addEventListener("change", async (e)=>{
      if(!UID){ alert("Fa√ßa login."); e.target.value=""; return; }
      const f=e.target.files[0]; if(!f) return;
      try{
        const text = await f.text(); const arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error("JSON inv√°lido");
        for(const a of arr){
          const payload = { data:a.data, fase:a.fase, grupo:a.grupo, sets:a.sets||[], obs:a.obs||"", volume:Number(a.volume||0),
            createdAt: serverTimestamp(), updatedAt: serverTimestamp() };
          await addActivity(payload);
        }
        await renderHistorico(); renderDash(); alert("Importa√ß√£o conclu√≠da!");
      }catch(err){ alert("Erro ao importar JSON."); }
      e.target.value="";
    });
  </script>
</body>
</html>
